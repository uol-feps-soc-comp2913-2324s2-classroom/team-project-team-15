{% extends "base.html" %}

{% block navbar %}
<nav id="navbar">
    <a href="{{ url_for('index') }}" class="nav-button">Journey List</a>
    <a href="{{ url_for('upload_gps') }}" class="nav-button">Add Journey</a>
    <a href="{{ url_for('display_journeys') }}" class="nav-button">Home</a>
    <button class="icon-button" onclick="SignUp()"><i class="bx bx-user"></i></button>

</nav>

{% endblock %}

{% block body %}

<body class="friendsBody">
    <div class="mainWhiteParent">
        <div class="mainWhite">
            <div class="friendsNav">
                <button class="fNavBtn" id="btn1" onclick="windowOpen1()">Search</button>
                <button class="fNavBtn" onclick="windowOpen2()">My Friends</button>
                <button class="fNavBtn" onclick="windowOpen3()">Requests</button>
            </div>
            <div class="searchFriend" style="display: none;" id="window1">
                <div class="topSearch">
                    <form id="searchForm">
                        <input class="typeText" type="text" name="query" placeholder="Search for usernames...">
                        <input class="searchBtn" type="submit" value="Search">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    </form>
                </div>

                <div id="searchResults" class="searchResults">
                    <ul>
                        {% for user in users %}
                        <li>
                            {{ user.username }}
                            {% if user.is_friend %}
                            <button disabled>Already Friends</button>
                            {% elif user.can_cancel %}
                            <button class="cancel-request" data-user-id="{{ user.id }}">Cancel Request</button>
                            {% else %}
                            <button class="send-request" data-user-id="{{ user.id }}">Request</button>
                            {% endif %}
                        </li>
                        {% endfor %}
                    </ul>

                </div>
            </div>

            <!-- Friends list section -->
            <div class="searchFriend" style="display: none;" id="window2">
                <!-- <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"> -->
                <div id="searchResults" class="searchResults">
                    <ul>
                        {% for friend in friends %}
                        <li id="friend-{{ friend.id }}">
                            {{ friend.username }}
                            <button class="unfriend-button" data-friend-id="{{ friend.id }}">Unfriend</button>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>

            <div class="searchFriend" style="display: none;" id="window3">
                <!-- <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"> -->
                <div id="searchResults" class="searchResults1">
                    <ul>
                        {% for request in requests %}
                        <li>
                            {{ request.requester.username }} wants to be friends.
                            <button class="respond-request" data-request-id="{{ request.id }}"
                                data-action="accept">Accept</button>
                            <button class="respond-request" data-request-id="{{ request.id }}"
                                data-action="reject">Reject</button>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>

        </div>
    </div>

</body>
{% endblock %}


{% block scripts %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>


    $(document).ready(function () {
        function updateSearchResults(htmlContent) {
            $('#searchResults').html(htmlContent);
            rebindSendRequestButtons(); // Rebind event handlers right after updating the content
            rebindCancelRequestButtons(); // Rebind cancel request buttons
        }


        function sendFriendRequest(userId, csrfToken) {
            $.ajax({
                url: `/send-friend-request/${userId}`,
                type: 'POST',
                headers: {
                    "X-CSRFToken": csrfToken,
                },
                success: function (response) {
                    alert(response.message);
                },
                error: function () {
                    alert('Error sending friend request.');
                }
            });
        }


        function rebindSendRequestButtons() {
            $('.send-request').off('click').on('click', function () {
                const userId = $(this).data('user-id');
                const csrfToken = $('input[name="csrf_token"]').val();
                sendFriendRequest(userId, csrfToken); // Extracted the AJAX call into a separate function
            });
        }

        function cancelFriendRequest(userId, csrfToken) {
            $.ajax({
                url: `/cancel-friend-request/${userId}`,
                type: 'POST',
                headers: {
                    "X-CSRFToken": csrfToken,
                },
                success: function (response) {
                    alert(response.message); // Display a success message
                    // Optionally update the UI, e.g., remove the cancel button or disable it
                    $(`button[data-user-id='${userId}']`).prop('disabled', true).text('Request Cancelled');
                },
                error: function () {
                    alert('Error canceling friend request.'); // Display an error message
                }
            });
        }

        function rebindCancelRequestButtons() {
            $('.cancel-request').off('click').on('click', function () {
                const userId = $(this).data('user-id');
                const csrfToken = $('input[name="csrf_token"]').val();
                cancelFriendRequest(userId, csrfToken); // Call the function with user ID and CSRF token
            });
        }



        $('input[name="query"]').on('keyup', function () {
            var query = $(this).val();
            var csrfToken = $('input[name="csrf_token"]').val();

            if (query.length === 0) {
                updateSearchResults('');
            } else {

                $.ajax({
                    url: '/search-users',
                    type: 'GET',
                    data: { query: query },
                    beforeSend: function (xhr) {
                        xhr.setRequestHeader("X-CSRFToken", csrfToken);
                    },
                    success: function (data) {
                        updateSearchResults(data.html); // This now automatically rebinds the click events
                    },
                    error: function () {
                        alert('Error searching for users.');
                    }
                });
            }
        });

        // Initial bind of the event handlers to ensure they are bound when the page loads
        rebindSendRequestButtons();
        rebindCancelRequestButtons();
    });

</script>
<script>
    $(document).ready(function () {
        function fetchAndDisplayFriendRequests() {
            $.getJSON('/fetch-friend-requests', function (requests) {
                var listItems = requests.map(function (req) {
                    return `<li>${req.username} wants to be friends. \
            <button class="respond-request" data-request-id="${req.id}" data-action="accept">Accept</button> \
            <button class="respond-request" data-request-id="${req.id}" data-action="reject">Reject</button></li>`;
                });
                $('#friendRequestsList').html(listItems.join(''));
                bindRespondRequestButtons();
            });
        }

        function bindRespondRequestButtons() {
            // This function will be called inside fetchAndDisplayFriendRequests to rebind the events
            $('.respond-request').off('click').on('click', function () {
                const button = $(this);
                const requestId = $(this).data('request-id');
                const action = $(this).data('action');
                const csrfToken = $('input[name="csrf_token"]').val();

                $.ajax({
                    url: `/respond-friend-request/${requestId}/${action}`,
                    method: 'POST',
                    headers: {
                        "X-CSRFToken": csrfToken
                    },
                    success: function (response) {
                        alert(response.message);
                        button.closest('li').fadeOut('slow', function () { $(this).remove(); });
                        fetchAndDisplayFriendRequests();  // Refresh the list
                    },
                    error: function (xhr, status, error) {
                        console.error(`Error - Status: ${status}, Error: ${error}`);
                        alert('There was an error processing your request.');
                    }
                });
            });
        }

        fetchAndDisplayFriendRequests();  // Initial call to fetch and display friend requests


    });
</script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script>
    $(document).ready(function () {
        // Bind a click event to unfriend buttons
        $('.unfriend-button').click(function () {
            // Get the friend ID from the button's data attribute
            const friendId = $(this).data('friend-id');
            // Construct the URL for the unfriend request
            const unfriendUrl = `/unfriend/${friendId}`;

            // Fetch the CSRF token from a hidden input (assumed to be included in your form)
            const csrfToken = $('input[name="csrf_token"]').val();

            // Send the POST request to the unfriend endpoint
            $.ajax({
                url: unfriendUrl,
                type: 'POST',
                data: { 'csrf_token': csrfToken },
                beforeSend: function (xhr, settings) {
                    xhr.setRequestHeader("X-CSRFToken", csrfToken);
                },
                success: function (response) {
                    // On success, remove the friend item from the list
                    $(`#friend-${friendId}`).remove();
                    alert('Friend successfully unfriended.');
                },
                error: function (xhr, status, error) {
                    // Handle errors (e.g., friend not found, not authenticated)
                    console.error('Failed to unfriend:', status, error);
                    alert('Failed to unfriend. Please try again.');
                }
            });
        });
    });
</script>
<script>
    const btnElList = document.querySelectorAll('.fNavBtn');
    btnElList.forEach(btnEl => {
        btnEl.addEventListener('click', () => {
            document.querySelector('.special')?.classList.remove('special');
            btnEl.classList.add('special');
        })
    })
</script>


<script>
    window.onload = function () {
        document.getElementById("btn1").click();
    };
    function windowOpen1() {
        const window1 = document.getElementById("window1");
        const window2 = document.getElementById("window2");
        const window3 = document.getElementById("window3");
        window1.style.display = "block";
        window2.style.display = "none";
        window3.style.display = "none";
    }
    function windowOpen2() {
        const window1 = document.getElementById("window1");
        const window2 = document.getElementById("window2");
        const window3 = document.getElementById("window3");
        window2.style.display = "block";
        window1.style.display = "none";
        window3.style.display = "none";
    }
    function windowOpen3() {
        const window1 = document.getElementById("window1");
        const window2 = document.getElementById("window2");
        const window3 = document.getElementById("window3");
        window3.style.display = "block";
        window1.style.display = "none";
        window2.style.display = "none";
    }
</script>


{% endblock %}