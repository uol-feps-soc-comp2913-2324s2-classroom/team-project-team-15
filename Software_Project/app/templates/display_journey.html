<!-- templates/display_journeys.html -->
{% extends 'base.html' %}

{% block body %}
<style>
    #map {
        height: 500px;
        /* Ensure the map has a specific height */
        width: 100%;
        /* Full width */
    }
</style>

<div id="map"></div>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>
<!-- Include Leaflet Routing Machine -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const map = L.map('map').setView([51.505, -0.09], 13); // Adjust center as needed
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        fetch('/api/journeys')
            .then(response => response.json())  // Make sure to handle the response as JSON
            .then(journeys => {
                journeys.forEach(journey => {
                    if (journey.data && journey.data.coordinates.length > 0) {
                        const waypoints = journey.data.coordinates.map(coord => L.latLng(coord.lat, coord.lon));
                        L.Routing.control({
                            waypoints: waypoints,
                            routeWhileDragging: false,
                            showAlternatives: false,
                            router: L.Routing.mapbox('sk.eyJ1IjoidGVhbXByb2plY3QiLCJhIjoiY2x2dTA2dWo1MTVjYTJqcnJ2YzF5ZmJwdyJ9.qE-gbM3WxoYX7glO5vq0XQ'), // Replace '<your Mapbox access token>' with your actual token
                            lineOptions: {
                                styles: [{ color: getRandomColor(), weight: 4 }]
                            },
                            addWaypoints: false
                        }).addTo(map);
                    }
                });
            })
            .catch(error => console.error('Error fetching or processing journeys:', error));

        function getRandomColor() {
            const letters = '0123456789ABCDEF';
            let color = '#';
            for (let i = 0; i < 6; i++) {
                color += letters[Math.floor(Math.random() * 16)];
            }
            return color;
        }
    });
</script>

{% endblock %}