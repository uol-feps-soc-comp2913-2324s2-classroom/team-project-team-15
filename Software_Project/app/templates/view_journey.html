<!-- templates/view_journey.html -->
{% extends 'base.html' %}

{% block navbar %}
<nav id="navbar">
    <a href="{{ url_for('upload_gps') }}" class="nav-button">Add Journey</a>
    <a href="{{ url_for('friends') }}" class="nav-button">Friends</a>
    <a href="{{ url_for('display_journeys') }}" class="nav-button">Home</a>
    <button class="icon-button" onclick="SignUp()"><i class="bx bx-user"></i></button>

</nav>
{% endblock %}

{% block body %}
<h2>Journey Details: {{ journey.name }}</h2>
<p>Type: {{ journey.type }}</p>
<p>Duration: {{ journey.duration }}</p>
<p>Distance: {{ journey.distance }}</p>
<p>Speed: {{ journey.speed}}</p>
<p>Calories: {{ journey.calories }}</p>

<div class="download-buttons">
    <a href="{{ url_for('download_journey', journey_id=journey.id, format='json') }}" class="btn btn-primary">Download
        JSON</a>
    <a href="{{ url_for('download_journey', journey_id=journey.id, format='csv') }}" class="btn btn-secondary">Download
        CSV</a>
</div>

<div id="map" style="height: 400px;"></div>

<div id="map"></div>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>
<!-- Include Leaflet Routing Machine -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const map = L.map('map').setView([51.505, -0.09], 13); // Adjust center as needed
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        fetch('/api/journeys')
            .then(response => response.json())  // Make sure to handle the response as JSON
            .then(journeys => {
                journeys.forEach(journey => {
                    if (journey.data && journey.data.coordinates.length > 0) {
                        const waypoints = journey.data.coordinates.map(coord => L.latLng(coord.lat, coord.lon));
                        L.Routing.control({
                            waypoints: waypoints,
                            routeWhileDragging: false,
                            showAlternatives: false,
                            router: L.Routing.mapbox('sk.eyJ1IjoidGVhbXByb2plY3QiLCJhIjoiY2x2dTA2dWo1MTVjYTJqcnJ2YzF5ZmJwdyJ9.qE-gbM3WxoYX7glO5vq0XQ'), // Replace '<your Mapbox access token>' with your actual token
                            lineOptions: {
                                styles: [{ color: getRandomColor(), weight: 4 }]
                            },
                            addWaypoints: false,
                            createMarker: function (i, waypoint, n) {
                                const marker = L.marker(waypoint.latLng).bindPopup(
                                    `<strong>Journey ID:</strong> ${journey.id}<br>
                                 <strong>Journey Name:</strong> ${journey.name}<br>   
                                 <strong>Type:</strong> ${journey.type}<br>
                                 <strong>Duration:</strong> ${parseFloat(journey.duration).toFixed(2)} hours<br>
                                <strong>Distance:</strong> ${parseFloat(journey.distance).toFixed(2)} km<br>
                                <strong>Calories Burned:</strong> ${parseFloat(journey.calories).toFixed(2)} kcal<br>
                                <strong>Average Speed:</strong> ${parseFloat(journey.speed).toFixed(2)} km/h`
                                );
                                return marker;
                            },
                            itinerary: false,

                            collapsible: true
                        }).addTo(map);

                    }
                });
            })
            .catch(error => console.error('Error fetching or processing journeys:', error));

        function getRandomColor() {
            const letters = '0123456789ABCDEF';
            let color = '#';
            for (let i = 0; i < 6; i++) {
                color += letters[Math.floor(Math.random() * 16)];
            }
            return color;

        }

    });
</script>
{% endblock %}